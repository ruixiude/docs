(window.webpackJsonp=window.webpackJsonp||[]).push([[97],{456:function(t,a,s){"use strict";s.r(a);var n=s(42),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"caching"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#caching"}},[t._v("#")]),t._v(" Caching")]),t._v(" "),s("p",[t._v("OkHttp 网络缓存默认是关闭的，用户可以选择开启。OkHttp 实现网络缓存功能依赖的是 RFC 标准，存在模糊定义的情况下，以当前比较流行的浏览器软件 Firefox/Chrome 为准。")]),t._v(" "),s("h2",{attrs:{id:"basic-usage"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#basic-usage"}},[t._v("#")]),t._v(" Basic Usage")]),t._v(" "),s("div",{staticClass:"language-kotlin line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-kotlin"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" client"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" OkHttpClient "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" OkHttpClient"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Builder")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cache")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Cache")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n        directory "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("File")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("application"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cacheDir"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http_cache"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// $0.05 worth of phone storage in 2020")]),t._v("\n        maxSize "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("50L")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1024L")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1024L")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 50 MiB")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("build")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br")])]),s("h2",{attrs:{id:"eventlistener-events"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#eventlistener-events"}},[t._v("#")]),t._v(" EventListener events")]),t._v(" "),s("p",[t._v("缓存的回调事件 API 为 EventListener，典型场景如下：")]),t._v(" "),s("h3",{attrs:{id:"cache-hit"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#cache-hit"}},[t._v("#")]),t._v(" Cache Hit")]),t._v(" "),s("p",[t._v("在理想情况下，缓存数据可以完全满足无需发起任何网络的请求。使用 Http 网络缓存数据后，将跳过常规网络请求事件，如 DNS 解析、连接到网络以及下载响应数据。")]),t._v(" "),s("p",[t._v("根据 HTTP RFC 的建议，基于 “Last-Modified”，文档的最长过期时间默认为文档计划服务时间的10%。默认过期日期不用于包含查询的URI。")]),t._v(" "),s("ul",[s("li",[t._v("CallStart")]),t._v(" "),s("li",[s("strong",[t._v("CacheHit")])]),t._v(" "),s("li",[t._v("CallEnd")])]),t._v(" "),s("h3",{attrs:{id:"cache-miss"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#cache-miss"}},[t._v("#")]),t._v(" Cache Miss")]),t._v(" "),s("p",[t._v("在缓存未命中的情况下，可以看到正常的请求事件，但另一个事件显示缓存的存在。如果数据项尚未从网络获取、不可缓存、缓存过期，则缓存未命中是很常见的。")]),t._v(" "),s("ul",[s("li",[t._v("CallStart")]),t._v(" "),s("li",[s("strong",[t._v("CacheMiss")])]),t._v(" "),s("li",[t._v("ProxySelectStart")]),t._v(" "),s("li",[t._v("... Standard Events ...")]),t._v(" "),s("li",[t._v("CallEnd")])]),t._v(" "),s("h3",{attrs:{id:"conditional-cache-hit"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#conditional-cache-hit"}},[t._v("#")]),t._v(" Conditional Cache Hit")]),t._v(" "),s("p",[t._v("当需要检查缓存结果仍然有效时，跟随在cachehit 或 miss后，会收到一个cacheConditionalHit事件。然后是缓存命中或未命中。 至关重要的是，在缓存命中的情况下，服务器不会发送响应正文。")]),t._v(" "),s("p",[t._v("在 HTTP/1.1 服务器返回的 Response 为 304 Not Modified 情况下，请求的 response 将返回非空的 "),s("code",[t._v("cacheResponse")]),t._v(" 和 "),s("code",[t._v("networkResponse")]),t._v("。"),s("code",[t._v("cacheResponse")]),t._v(" 的优先级最高。")]),t._v(" "),s("ul",[s("li",[t._v("CallStart")]),t._v(" "),s("li",[s("strong",[t._v("CacheConditionalHit")])]),t._v(" "),s("li",[t._v("ConnectionAcquired")]),t._v(" "),s("li",[t._v("... Standard Events...")]),t._v(" "),s("li",[t._v("ResponseBodyEnd "),s("em",[t._v("(0 bytes)")])]),t._v(" "),s("li",[s("strong",[t._v("CacheHit")])]),t._v(" "),s("li",[t._v("ConnectionReleased")]),t._v(" "),s("li",[t._v("CallEnd")])]),t._v(" "),s("h2",{attrs:{id:"cache-directory"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#cache-directory"}},[t._v("#")]),t._v(" Cache directory")]),t._v(" "),s("p",[t._v("缓存目录必须有且仅有一个单例类持有。")]),t._v(" "),s("p",[t._v("可以在不再需要缓存时删除它，然而，这可能会删除缓存是为了在应用程序重新启动之间持久化的目的。")]),t._v(" "),s("div",{staticClass:"language-kotlin line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-kotlin"}},[s("code",[t._v("cache"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("delete")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("h2",{attrs:{id:"pruning-the-cache"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#pruning-the-cache"}},[t._v("#")]),t._v(" Pruning the Cache")]),t._v(" "),s("p",[t._v("可以使用 "),s("code",[t._v("evictAll")]),t._v(" 删除整个缓存临时清理空间：")]),t._v(" "),s("div",{staticClass:"language-kotlin line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-kotlin"}},[s("code",[t._v("cache"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("evictAll")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("可以使用 url 迭代方式，删除某个单独的Item。典型的应用场景是，用户通过 "),s("code",[t._v("下拉刷新（pull to refresh）")]),t._v(" 强制启动一个刷新动作。")]),t._v(" "),s("div",{staticClass:"language-kotlin line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-kotlin"}},[s("code",[t._v("    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("val")]),t._v(" urlIterator "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" cache"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("urls")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("urlIterator"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("hasNext")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("urlIterator"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("next")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("startsWith")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://www.google.com/"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        urlIterator"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("remove")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br")])]),s("h3",{attrs:{id:"troubleshooting"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#troubleshooting"}},[t._v("#")]),t._v(" Troubleshooting")]),t._v(" "),s("p",[s("em",[t._v("1、有效的、可缓存的响应数据，未被缓存（Valid cacheable responses are not being cached）")])]),t._v(" "),s("p",[t._v("确保完全读取响应数据，除非完全读取响应数据 或 请求被取消。")]),t._v(" "),s("h3",{attrs:{id:"overriding-normal-cache-behaviour"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#overriding-normal-cache-behaviour"}},[t._v("#")]),t._v(" Overriding normal cache behaviour")]),t._v(" "),s("p",[t._v("请参阅缓存文档 "),s("a",{attrs:{href:"https://square.github.io/okhttp/4.x/okhttp/okhttp3/-cache/",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://square.github.io/okhttp/4.x/okhttp/okhttp3/-cache/"),s("OutboundLink")],1)])])}),[],!1,null,null,null);a.default=e.exports}}]);